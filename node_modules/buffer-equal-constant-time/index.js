/*jshint node:true */
'use strict';

var Buffer = require('buffer').Buffer; // browserify-safe

module.exports = bufferEq;

function bufferEq(a, b) {
  // shortcutting on type is necessary for correctness
  if (!Buffer.isBuffer(a) || !Buffer.isBuffer(b)) {
    return false;
  }

  // buffer sizes should be well-known information, so despite this
  // shortcutting, it doesn't leak any information about the *contents* of the
  // buffers.
  if (a.length !== b.length) {
    return false;
  }

  var c = 0;
  for (var i = 0; i < a.length; i++) {
    /*jshint bitwise:false */
    c |= a[i] ^ b[i]; // XOR
  }
  return c === 0;
}

// --- Prototype patching helpers (no SlowBuffer needed) ---
var _installed = false;
var _origBufEqual = Buffer.prototype.equal; // may be undefined

bufferEq.install = function () {
  if (_installed) return;
  Buffer.prototype.equal = function equal(that) {
    return bufferEq(this, that);
  };
  _installed = true;
};

bufferEq.restore = function () {
  if (!_installed) return;
  if (typeof _origBufEqual === 'function') {
    Buffer.prototype.equal = _origBufEqual;
  } else {
    // if there was no original, remove the property to restore the prior state
    delete Buffer.prototype.equal;
  }
  _installed = false;
};
